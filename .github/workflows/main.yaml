name: Laravel CI/CD Job

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: ${{secrets.APP_NAME}}
  APP_ENV: ${{secrets.APP_ENV}}
  APP_KEY: ${{secrets.APP_KEY}}
  APP_DEBUG: ${{secrets.APP_DEBUG}}
  APP_URL: ${{secrets.APP_URL}}
  LOG_CHANNEL: ${{secrets.LOG_CHANNEL}}
  LOG_DEPRECATIONS_CHANNEL: ${{secrets.LOG_DEPRECATIONS_CHANNEL}}
  LOG_LEVEL: ${{secrets.LOG_LEVEL}}
  DB_CONNECTION: ${{secrets.DB_CONNECTION}}
  DB_HOST: ${{secrets.DB_HOST}}
  DB_PORT: ${{secrets.DB_PORT}}
  DB_DATABASE: ${{secrets.DB_DATABASE}}
  DB_USERNAME: ${{secrets.DB_USERNAME}}
  DB_PASSWORD: ${{secrets.DB_PASSWORD}}
  BROADCAST_DRIVER: ${{secrets.BROADCAST_DRIVER}}
  CACHE_DRIVER: ${{secrets.CACHE_DRIVER}}
  FILESYSTEM_DISK: ${{secrets.FILESYSTEM_DISK}}
  QUEUE_CONNECTION: ${{secrets.QUEUE_CONNECTION}}
  SESSION_DRIVER: ${{secrets.SESSION_DRIVER}}
  SESSION_LIFETIME: ${{secrets.SESSION_LIFETIME}}
  MEMCACHED_HOST: ${{secrets.MEMCACHED_HOST}}
  REDIS_HOST: ${{secrets.REDIS_HOST}}
  REDIS_PASSWORD: ${{secrets.REDIS_PASSWORD}}
  REDIS_PORT: ${{secrets.REDIS_PORT}}
  MIX_PUSHER_APP_KEY: ${{secrets.MIX_PUSHER_APP_KEY}}
  MIX_PUSHER_APP_CLUSTER: ${{secrets.MIX_PUSHER_APP_CLUSTER}}

jobs:
  init:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v3
    - name: .env File
      run: mv .env.example .env
    - name: Install Depedencies
      run: |
        docker run --rm \
        -u "$(id -u):$(id -g)" \
        -v $(pwd):/var/www/html \
        -w /var/www/html \
        laravelsail/php81-composer:latest \
        composer install --ignore-platform-reqs
    - name: Start Project :D
      run: ./vendor/bin/sail up -d
